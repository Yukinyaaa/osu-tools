const bbcode_parser=c=>{if(!c)return"";c=c.replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll("\n","<br>");let i="b|i|u|s|strike|color|size|spoiler|box|spoilerbox|quote|code|centre|url|profile|list|\\*|img|youtube|audio|heading|notice",j=(b,d)=>{let j=a[b]+a[b+1]+a[d];if(!j)return;let g=d-b+1,k,c=null,e=null,l=j.match(/^\[\*\].*/),f=j.match(new RegExp("^\\[("+i+")(?:=(.*?))?\\](.*)\\[\\/("+i+")\\]$"));if(l){a[b]="<li>";for(let h=b+1;h<a.length;h++)if(a[h].match(/(?:\[\*\]|\[\/list\]|<br>)/)){a.splice(h,0,"</li>");return}a.push("</li>");return}if(f&&f[1]==f[4])switch(k=f[1],c=f[2],e=f[3],k){case"b":c||(a[b]="<strong>",a[d]="</strong>");break;case"i":c||(a[b]="<em>",a[d]="</em>");break;case"u":c||(a[b]="<u>",a[d]="</u>");break;case"s":case"strike":c||(a[b]="<del>",a[d]="</del>");break;case"color":c&&c.match(new RegExp("^(?:(?:black|silver|gray|white|maroon|red|purple|fuchsia|green|lime|olive|yellow|navy|blue|teal|aqua|orange|aliceblue|antiquewhite|aquamarine|azure|beige|bisque|blanchedalmond|blueviolet|brown|burlywood|cadetblue|chartreuse|chocolate|coral|cornflowerblue|cornsilk|crimson|cyan|darkblue|darkcyan|darkgoldenrod|darkgray|darkgreen|darkgrey|darkkhaki|darkmagenta|darkolivegreen|darkorange|darkorchid|darkred|darksalmon|darkseagreen|darkslateblue|darkslategray|darkslategrey|darkturquoise|darkviolet|deeppink|deepskyblue|dimgray|dimgrey|dodgerblue|firebrick|floralwhite|forestgreen|gainsboro|ghostwhite|gold|goldenrod|greenyellow|grey|honeydew|hotpink|indianred|indigo|ivory|khaki|lavender|lavenderblush|lawngreen|lemonchiffon|lightblue|lightcoral|lightcyan|lightgoldenrodyellow|lightgray|lightgreen|lightgrey|lightpink|lightsalmon|lightseagreen|lightskyblue|lightslategray|lightslategrey|lightsteelblue|lightyellow|limegreen|linen|magenta|mediumaquamarine|mediumblue|mediumorchid|mediumpurple|mediumseagreen|mediumslateblue|mediumspringgreen|mediumturquoise|mediumvioletred|midnightblue|mintcream|mistyrose|moccasin|navajowhite|oldlace|olivedrab|orangered|orchid|palegoldenrod|palegreen|paleturquoise|palevioletred|papayawhip|peachpuff|peru|pink|plum|powderblue|rosybrown|royalblue|saddlebrown|salmon|sandybrown|seagreen|seashell|sienna|skyblue|slateblue|slategray|slategrey|snow|springgreen|steelblue|tan|thistle|tomato|turquoise|violet|wheat|whitesmoke|yellowgreen|rebeccapurple)|#[a-fA-F0-9]{6})$"))&&(a[b]='<span style="color:'+c+'">',a[d]="</span>");break;case"size":-1!=["50","85","100","150"].indexOf(c)&&(a[b]='<span class="size-'+c+'">',a[d]="</span>");break;case"spoiler":c||(a[b]='<span class="spoiler">',a[d]="</span>");break;case"spoilerbox":c="SPOILER";case"box":c&&(a[b]='<div class="js-spoilerbox bbcode-spoilerbox"><button class="js-spoilerbox__link bbcode-spoilerbox__link" type="button"><span class="bbcode-spoilerbox__link-icon"></span>'+c+'</button><div class="bbcode-spoilerbox__body">',a[d]="</div></div>");break;case"quote":c&&c.match(/^".+"$/)?(a[b]="<blockquote><h4>"+c.replace(/"(.+)"/,"$1")+" wrote:</h4>",a[d]="</blockquote>"):c||(a[b]="<blockquote>",a[d]="</blockquote>");break;case"code":c||(a[b]="<pre>",a[d]="</pre>");break;case"centre":c||(a[b]="<center>",a[d]="</center>");break;case"url":c&&c.match(/^(?:https?|ftps?):\/\/.+?\..+?.*$/)&&e?(a[b]='<a rel="nofollow" href="'+c.replaceAll('"','\\"')+'">',a[d]="</a>"):!c&&e.match(/^(?:https?|ftps?):\/\/\w+?\.\w+?.*$/)&&3==g&&(a[b]='<a rel="nofollow" href="'+e.replaceAll('"','\\"')+'">',a[d]="</a>");break;case"profile":e.match(/^[\w- \[\]]+$/)&&3==g&&(a[b]='<a class="user-name js-usercard" href="https://osu.ppy.sh/users/'+e+'" data-user-id="'+e+'">',a[d]="</a>");break;case"list":c?(a[b]="<ol>",a[d]="</ol>"):(a[b]='<ol class="unordered">',a[d]="</ol>");break;case"img":!c&&e.match(/^(?:https?|ftps?):\/\/.+?\..+?.*$/)&&3==g&&(a[b]='<span class="proportional-container js-gallery"><span class="proportional-container__height"><img style="position:relative" src="'+e+'" alt=""></span></span><br>',a[b+1]="",a[d]="");break;case"youtube":!c&&e.match(/^[\w-]{11}$/)&&3==g&&(a[b]='<div class="bbcode__video-box"><div class="bbcode__video"><iframe src="https://www.youtube.com/embed/'+e+'?rel=0" frameborder="0"></iframe></div></div>',a[b+1]="",a[d]="");break;case"audio":!c&&e.match(/^(?:https?|ftps?):\/\/.+?\..+?.*$/)&&3==g&&(a[b]='<div class="audio-player js-audio--player" data-audio-url="'+e+'" data-audio-state="paused" data-audio-autoplay="1" data-audio-has-duration="1" data-audio-time-format="minute_minimal" data-audio-over50="0" style="--duration:&quot;0:00&quot;; --current-time:&quot;0:00&quot;; --progress:0;"><button type="button" class="audio-player__button audio-player__button--play js-audio--play"><span class="fa-fw play-button"></span></button><div class="audio-player__bar audio-player__bar--progress js-audio--seek"><div class="audio-player__bar-current"></div></div><div class="audio-player__timestamps"><div class="audio-player__timestamp audio-player__timestamp--current"></div><div class="audio-player__timestamp-separator">/</div><div class="audio-player__timestamp audio-player__timestamp--total"></div></div></div>',a[b+1]="",a[d]="");break;case"heading":c||(a[b]="<h2>",a[d]="</h2>");break;case"notice":c||(a[b]='<div class="well">',a[d]="</div>")}},a=c.split(new RegExp("(\\[\\/?(?:"+i+")(?:=.*?)?\\]|\n)")).filter(a=>""!=a),k=new RegExp("^\\[(\\/)?("+i+")(?:=(.*?))?\\]$");for(let b=0;b<a.length;b++){let d=a[b].match(k);if(d){let l=b,f=-1;if(void 0==d[1]){if("*"!=d[2]){let g=0;for(let e=b+1;e<a.length;e++){let h=a[e].match(k);if(h&&d[2]==h[2]){if(void 0==h[1])g++;else{if(0==g){f=e;break}g--}}}-1!=f&&j(l,f)}else j(l,a.length-1)}}}return a.join("")}
